# JVM 原理



### 架构图

![jvm_m_l](http://images2015.cnblogs.com/blog/331425/201606/331425-20160623115841781-223449019.png)



### 含义

- -Xmx设置堆的最大空间大小。
- -Xms设置堆的最小空间大小。
- -XX:MaxNewSize设置新生代最大空间大小。
- -XX:NewSize设置新生代最小空间大小。
- -XX:MaxPermSize设置永久代最大空间大小。
- -XX:PermSize设置永久代最小空间大小。
- -Xss设置每个线程的堆栈大小。



### Roots

![img](http://dl.iteye.com/upload/attachment/0075/0410/60e7c659-790a-3405-af70-9ca4cfd9258d.jpg)

### GC 收集器

* Serial、ParNew等带Compact过程的收集器时，JVM采用指针碰撞方式分配内存；

* CMS这种基于标记-清除（Mark-Sweep）算法的收集器时，采用空闲列表

* ​

* Serial 顺序单线程执行 GC  -XX:+UseSerialGC

* Parallel GC 多线程执行 -XX:+UseParallelGC -XX:ParallelGCThreads=<线程数目>

  * `-XX:+UseParallelOldGC`可以让新生代和老年代同时使用多线程并行垃圾收集；在老年代：标记-整理算法，会在标记后将存活对象搬运到一起来防止出现内存碎片。

* Parallel Scavenge (1.8jdk)

  * ：-XXMaxGCPauseMillis 允许垃圾收集的最大停顿时间，默认值为很大的一个数18446744073709551615，它的单位是毫秒，这能忍？
  * -XX:GCTimeRatio 另一个是吞吐量，默认值为99，取值范围是1 - 100
  * -XX:+UseAdaptiveSizePolicy 自动内存调节，动态调节Eden、Survivor空间的比例来达到用户设置的目标

* Serial Old  标记整理算法，

  ​	用途，一个是作为CMS收集器的备点，当CMS收集器出现Concurrent Mode Failure的时候会临时启用Serial Old收集器进行垃圾回收，另外一个是在Java5以及之前版本和Parallel Scavenge收集器配合使用。

* Parallel Old 标记整理算法

  ​	从Java6开始提供，在Java6以前，Parallel Scavenge新生代收集器只能和Serial Old收集器配合使用，到了Java6及以后Parallel Scavenge和Parallel Old是默认搭配

* CMS （Concurrent Mark Sweep ） -XX:+UseConcMarkSweepGC 最少停顿时间为目标的老年代收集器 标记清除

  * 初始标记、并发标记、重新标记、并发清除

* ### Concurrent Mark Sweep （CMS）-XX:+UseConcMarkSweepGC

* ### 

  * ### 年轻代同 ParGC，老年代 标记-清除 算法

  * ### 初始标记(CMS-initial-mark) ：标记 Roots 能直接引用到的对象

  * ### 并发标记(CMS-concurrent-mark)：进行 GC Root Tracing

  * ### 重新标记(CMS-remark) ：修正并发标记期间由于用户程序运行而导致的变动

  * ### 并发清除(CMS-concurrent-sweep)：进行清除工作


### 一个对象从出生到销毁

* https://www.cnblogs.com/dingyingsi/p/3760730.html


* new jvm检测对象是否被加载，执行类加载过程

* 分配内存空间

  jvm采用什么分配方式由GC 收集器决定

  * Serial ParNew 指针碰撞，如果内存是整齐的；jvm采用CAS和失败重试保证分配线程安全
  * CMS              空闲列表，如果内存不整齐，不是顺序的

* GC

  * 引用计数器，为零时表示没有引用
  * 可达性分析算法， GC ROOTS

http://www.jianshu.com/p/9966a02b8ee9



### JVM 优化

jstat 查看 各区域使用情况以及fullgc情况

* http://blog.csdn.net/zhaozheng7758/article/details/8623549

jstack查看线程情况是否有死锁

jmap dump 内存使用情况

优化CMS fullgc 百分比



### 参考资料

* https://www.cnblogs.com/ityouknow/p/5610232.html
* http://jbutton.iteye.com/blog/1569746

